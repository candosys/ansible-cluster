---
- hosts: localhost

  vars:
  - db_name: "cluster-data"
  - db_user: "cluster-app"
  - db_user_password: "cluster-password"
  - db_root_password: ""

  tasks:
    - name: remove mysql packages
      apt: name={{ item }} state=absent
      with_items:
        - mysql-client
        - mysql-server
        - python-mysqldb

    - name: install mysql packages
      apt: name={{ item }} state=present
      with_items:
        - mysql-client
        - mysql-server
        - python-mysqldb

    - name: interpolate my.cnf server configuration
      template: src=my.cnf.j2 dest=/etc/mysql/my.cnf owner=root group=root mode=0600

    - name: restart mysql
      service: name=mysql state=restarted

    - name: create a database
      mysql_db: login_user=root login_password={{ db_root_password }} name={{ db_name }} collation=utf8_general_ci encoding=utf8 state=present

    - name: create a database user
      mysql_user: login_user=root login_password={{ db_root_password }} name={{ db_user }} password={{ db_user_password }} priv="{{ db_name }}.*:ALL" host='%' state=present

